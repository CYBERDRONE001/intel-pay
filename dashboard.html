<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Dashboard â€“ IntelPay</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white p-6 min-h-screen">
  <nav class="flex justify-between items-center mb-6 bg-gray-800 p-4 rounded">
    <h1 class="text-xl font-bold">IntelPay Dashboard</h1>
    <button id="logoutBtn" class="bg-red-600 px-4 py-1 rounded">Logout</button>
  </nav>

  <section>
    <h2 class="text-2xl font-semibold">Hello, <span id="userName" class="text-green-400"></span></h2>
    <p class="mt-2">ðŸ’° Earnings: <span id="earnings" class="text-blue-400 font-bold">â‚¦0</span></p>
    <p class="mt-2">ðŸ“¦ Plan: <span id="plan" class="text-yellow-400">â€”</span></p>
    <p class="mt-2">ðŸ”— Referral Link:</p>
    <code id="refLink" class="block bg-gray-800 p-2 rounded text-sm"></code>

    <img id="miningImage" src="" alt="Mining Rig" class="mt-4 rounded shadow max-w-full border border-gray-700" />

    <a href="withdraw.html" class="block mt-6 bg-green-600 px-4 py-2 text-center rounded hover:bg-green-500">Withdraw</a>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGdIsemWvuUTe7Df6iOK7suxMRC8G0vNg",
      authDomain: "intel-pay-ltd.firebaseapp.com",
      projectId: "intel-pay-ltd",
      storageBucket: "intel-pay-ltd.appspot.com",
      messagingSenderId: "779411397815",
      appId: "1:779411397815:web:7b6d9f34572d13a833c132"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userName = document.getElementById("userName");
    const earningsEl = document.getElementById("earnings");
    const refLink = document.getElementById("refLink");
    const planName = document.getElementById("plan");
    const miningImg = document.getElementById("miningImage");
    const logoutBtn = document.getElementById("logoutBtn");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";

      const docRef = doc(db, "users", user.uid);
      const snap = await getDoc(docRef);
      const data = snap.data();

      userName.textContent = data.name || user.email;
      refLink.textContent = `${location.origin}/register.html?ref=${user.uid}`;

      if (!data.activated || !data.activatedAt || !data.earningsRate) {
        earningsEl.textContent = "â‚¦0";
        planName.textContent = "No plan selected";
        miningImg.src = "https://i.imgur.com/aDvhZ0n.jpg";
        return;
      }

      const startDate = new Date(data.activatedAt.seconds * 1000);
      const now = new Date();
      const days = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));

      const rate = data.earningsRate;
      const base = data.initialAmount;
      const max = 5500;

      const current = Math.min(base * rate * days, max);
      await updateDoc(docRef, { earnings: current });

      earningsEl.textContent = `â‚¦${current.toFixed(2)}`;
      planName.textContent = data.miningPlan?.toUpperCase() || "â€”";
      miningImg.src = data.miningImage || "https://i.imgur.com/aDvhZ0n.jpg";
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth).then(() => location.href = "login.html");
    });
  </script>
</body>
</html>