<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment – IntelPay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://checkout.flutterwave.com/v3.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white p-6 min-h-screen">
  <h2 class="text-2xl font-bold mb-6">Choose Your Payment Method</h2>

  <div class="space-y-4 max-w-xl">
    <button id="paystackBtn" class="w-full bg-blue-600 p-4 rounded">Pay with Paystack</button>
    <button id="flutterwaveBtn" class="w-full bg-purple-600 p-4 rounded">Pay with Flutterwave</button>

    <div class="bg-gray-800 p-4 rounded mt-6">
      <h3 class="text-lg font-semibold mb-2">Crypto Payment</h3>
      <p>Send payment to: <span class="text-green-400">bc1q-your-wallet-address</span></p>
      <p>Upload your screenshot to <a href="https://imgbb.com" class="underline text-blue-400" target="_blank">imgbb.com</a> and paste the link:</p>
      <input type="url" id="cryptoLink" placeholder="https://ibb.co/your-image" class="w-full p-2 mt-2 bg-gray-700 rounded" />
      <button id="submitLink" class="mt-3 bg-green-600 p-2 rounded">Submit Screenshot</button>
      <p class="text-green-400 mt-2 hidden" id="linkSaved">✅ Link submitted. Admin will verify.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { jsPDF } from "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDGdIsemWvuUTe7Df6iOK7suxMRC8G0vNg",
      authDomain: "intel-pay-ltd.firebaseapp.com",
      projectId: "intel-pay-ltd",
      storageBucket: "intel-pay-ltd.appspot.com",
      messagingSenderId: "779411397815",
      appId: "1:779411397815:web:7b6d9f34572d13a833c132"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    let userData = null;

    const paystackKey = "pk_test_xxxxxxxxxxxxx"; // ⚠️ Replace with your real key
    const flutterwaveKey = "FLWPUBK_TEST-xxxxxxxxxxxxx"; // ⚠️ Replace with your real key

    const generatePDFReceipt = (name, email, method, amount) => {
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("IntelPay Payment Receipt", 20, 20);
      doc.setFontSize(12);
      doc.text(`Name: ${name}`, 20, 40);
      doc.text(`Email: ${email}`, 20, 50);
      doc.text(`Method: ${method}`, 20, 60);
      doc.text(`Amount: ₦${amount}`, 20, 70);
      doc.text(`Date: ${new Date().toLocaleString()}`, 20, 80);
      doc.text("Thank you for investing with IntelPay.", 20, 100);
      doc.save("IntelPay-Receipt.pdf");
    };

    onAuthStateChanged(auth, async (_user) => {
      if (!_user) return location.href = "login.html";
      user = _user;
      const snap = await getDoc(doc(db, "users", user.uid));
      userData = snap.data();
    });

    document.getElementById("paystackBtn")?.addEventListener("click", () => {
      const amount = userData.initialAmount * 100;

      PaystackPop.setup({
        key: paystackKey,
        email: user.email,
        amount: amount,
        currency: "NGN",
        callback: async (res) => {
          await updateDoc(doc(db, "users", user.uid), {
            activated: true,
            activatedAt: new Date(),
            paymentMethod: "Paystack",
            transactionRef: res.reference
          });
          generatePDFReceipt(user.displayName || "User", user.email, "Paystack", userData.initialAmount);
          alert("Payment successful!");
          location.href = "dashboard.html";
        }
      }).openIframe();
    });

    document.getElementById("flutterwaveBtn")?.addEventListener("click", () => {
      FlutterwaveCheckout({
        public_key: flutterwaveKey,
        tx_ref: "INTELPAY_" + Date.now(),
        amount: userData.initialAmount,
        currency: "NGN",
        customer: { email: user.email },
        callback: async function (response) {
          await updateDoc(doc(db, "users", user.uid), {
            activated: true,
            activatedAt: new Date(),
            paymentMethod: "Flutterwave",
            transactionId: response.transaction_id
          });
          generatePDFReceipt(user.displayName || "User", user.email, "Flutterwave", userData.initialAmount);
          alert("Payment successful!");
          location.href = "dashboard.html";
        }
      });
    });

    document.getElementById("submitLink")?.addEventListener("click", async () => {
      const link = document.getElementById("cryptoLink").value;
      if (!link.startsWith("http")) return alert("Enter valid image link");

      await updateDoc(doc(db, "users", user.uid), {
        cryptoPaymentProof: link,
        paymentMethod: "Crypto Screenshot",
        activated: false
      });

      generatePDFReceipt(user.displayName || "User", user.email, "Crypto Screenshot", userData.initialAmount);
      document.getElementById("linkSaved").classList.remove("hidden");
    });
  </script>
</body>
</html>